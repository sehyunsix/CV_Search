name: Docker Compose Deploy to NCP in dev_typescript branch
run-name: Deploying to NCP in dev_typescript branch

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'deploy'
        type: choice
        options:
          - 'deploy'
          - 'restart'
          - 'stop'
          - 'update'

jobs:
  build-and-push:
    name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event_name == 'pull_request'
    # crawl-ts ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
    paths:
      - 'crawl-ts/**'
      - 'Dockerfile'
      - '.github/workflows/**'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/crawl-server:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/crawl-server:latest

  deploy:
    name: NCP ì„œë²„ ë°°í¬
    runs-on: ubuntu-latest
    # build-and-pushê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•„ë„ ê³„ì† ì‹¤í–‰ë˜ë„ë¡ optional dependency ì„¤ì •
    needs: [build-and-push]
    if: always()  # build-and-pushê°€ skip ë˜ì–´ë„ ì‹¤í–‰
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡ í™•ì¸
        run: ls -la

      - name: í™˜ê²½ ë³€ìˆ˜ ì ìš© - docker-compose.yml ì—…ë°ì´íŠ¸
        run: cat docker-compose.yml

      - name: CV_Search ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ë™
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          password: ${{ secrets.NCP_PASSWORD }}
          port: ${{ secrets.NCP_PORT }}
          script: |
            mkdir -p ~/CV_Search
            rm -f ~/CV_Search/docker-compose.yml
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: docker-compose íŒŒì¼ ì „ì†¡ ë° ë°°í¬
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          password: ${{ secrets.NCP_PASSWORD }}
          port: ${{ secrets.NCP_PORT }}
          source: "./docker-compose.yml"
          target: "~/CV_Search/"
          overwrite: true

      - name: ë°°í¬ ì‹¤í–‰ ë° í™•ì¸
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          password: ${{ secrets.NCP_PASSWORD }}
          port: ${{ secrets.NCP_PORT }}
          script: |
            set -e
            cd ~/CV_Search

            echo "[1/6] ì´ë¯¸ì§€ Pull"
            docker-compose pull crawl parser

            echo "[2/6] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ ë° ì œê±°"
            docker-compose down crawl parser

            echo "[3/6] ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            docker-compose up crawl parser -d

            echo "[4/6] ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬"
            docker image prune -f

            echo "[5/6] ì‹¤í–‰ ìƒíƒœ í™•ì¸"
            docker-compose ps

            echo "[6/6] ì„œë¹„ìŠ¤ ìƒíƒœ í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°)"

            check_service_up() {
              local service_name=$1
              local max_attempts=10
              local attempt=1
              echo "ğŸ” Checking $service_name..."

              while [ $attempt -le $max_attempts ]; do
                if docker-compose ps | grep "$service_name" | grep -q "Up"; then
                  echo "âœ… $service_name is running (attempt $attempt)"
                  return 0
                fi
                echo "â³ $service_name not ready (attempt $attempt)..."
                attempt=$((attempt + 1))
                sleep 1
              done

              echo "âŒ $service_name failed to start within $max_attempts seconds"
              docker-compose logs $service_name
              exit 1
            }

            check_service_up crawl
            check_service_up parser

            echo "ğŸ‰ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"